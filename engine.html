<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Searsia search client" />
    <meta name="author" content="Djoerd Hiemstra" />
    <link id="favicon" rel="icon" type="image/png" href="images/search.png" />

    <title>Engine</title>

    <link href="css/bootstrap.min.css" rel="stylesheet" />
    <link href="css/searsia.css" rel="stylesheet" />

  </head>

  <body>

    <div class="container theme-settings">

      <div class="row">
        <div class="col-md-10">
          <div class="searsia-settings">
            <a href="index.html">
            <div id="searsia-banner" class="searsia-banner" style="display:none">
              <img src="" alt=""/>
            </div>
            </a>
            <div id="searsia-engines">
              <div id="searsia-alert-top"></div>

<form id="searsia-engine-form" class="form-horizontal">
  <div class="form-group">
    <label for="engine-id" class="col-sm-2 control-label">Id:</label>
    <div class="col-sm-4">
      <input type="text" class="form-control" id="engine-id" name="id" placeholder="Add a new engine"/>
    </div>
  </div>
  <div class="form-group">
    <label for="engine-apitemplate" class="col-sm-2 control-label">API template:</label>
    <div class="col-sm-9">
      <input type="text" class="form-control" id="engine-apitemplate" name="apitemplate" placeholder="-required-"/>
    </div>
  </div>
  <div class="form-group">
    <label for="engine-post" class="col-sm-2 control-label">Post string:</label>
    <div class="col-sm-9">
      <input type="text" class="form-control" id="engine-post" name="post"/>
    </div>
  </div>
  <div class="form-group">
    <label for="engine-mimetype" class="col-sm-2 control-label">Mime type:</label>
    <div class="col-sm-4">
      <input type="text" class="form-control" id="engine-mimetype" name="mimetype"/>
    </div>
  </div>
  <div class="form-group">
    <label for="engine-name" class="col-sm-2 control-label">Name:</label>
    <div class="col-sm-4">
      <input type="text" class="form-control" id="engine-name" name="name"/>
    </div>
  </div>
  <div class="form-group">
    <label for="engine-favicon" class="col-sm-2 control-label">Icon:</label>
    <div class="col-sm-9">
      <input type="text" class="form-control" id="engine-favicon" name="favicon"/>
    </div>
  </div>
  <div class="form-group">
    <label for="engine-urltemplate" class="col-sm-2 control-label" style="text-wrap:none">User template:</label>
    <div class="col-sm-9">
      <input type="text" class="form-control" id="engine-urltemplate" name="urltemplate"/>
    </div>
  </div>
  <div class="form-group">
    <label for="engine-testquery" class="col-sm-2 control-label">Test query:</label>
    <div class="col-sm-4">
      <input type="text" class="form-control" id="engine-testquery" name="testquery"/>
    </div>
  </div>
  <div class="form-group">
    <label for="engine-itempath" class="col-sm-2 control-label">Item XPath:</label>
    <div class="col-sm-4">
      <input type="text" class="form-control" id="engine-itempath" name="itempath"/>
    </div>
  </div>
  <div class="form-group">
    <label for="engine-xpath-key-0" class="col-sm-2 control-label">XPaths:</label>
    <div class="col-sm-4">
      <input type="text" class="form-control" id="engine-xpath-key-0" name="engine-xpath-key-0"/>
    </div>
    <div class="col-sm-4">
      <input type="text" class="form-control" id="engine-xpath-value-0" name="engine-xpath-value-0"/>
    </div>
    <div class="col-sm-2">
      <button type="button" class="btn btn-default" onclick="addLine('xpath');">+</button>
    </div>
  </div>
  <div id="engine-additional-xpath"></div>

  <div class="form-group">
    <label for="engine-header-key-0" class="col-sm-2 control-label">Headers:</label>
    <div class="col-sm-4">
      <input type="text" class="form-control" id="engine-header-key-0" name="engine-header-key-0"/>
    </div>
    <div class="col-sm-4">
      <input type="text" class="form-control" id="engine-header-value-0" name="engine-header-value-0"/>
    </div>
    <div class="col-sm-2">
      <button type="button" class="btn btn-default" onclick="addLine('header');">+</button>
    </div>
  </div>
  <div id="engine-additional-header"></div>

  <div class="form-group">
    <label for="engine-param-key-0" class="col-sm-2 control-label">Parameters:</label>
    <div class="col-sm-4">
      <input type="text" class="form-control" id="engine-param-key-0" name="engine-param-key-0"/>
    </div>
    <div class="col-sm-4">
      <input type="text" class="form-control" id="engine-param-value-0" name="engine-param-value-0"/>
    </div>
    <div class="col-sm-2">
      <button type="button" class="btn btn-default" onclick="addLine('param');">+</button>
    </div>
  </div>
  <div id="engine-additional-param"></div> 

  <div class="form-group">
    <label class="col-sm-2 control-label">Type:</label>
    <div class="col-sm-10">
      <div class="radio">
        <label> <input type="radio" name="engineType" id="engine-type-atmother" value="atmother" checked />
          At Mother</label>
      </div>
      <div class="radio">
        <label> <input type="radio" name="engineType" id="engine-type-local" value="local"/>
          Local </label>
      </div>
      <div class="radio">
        <label> <input type="radio" name="engineType" id="engine-type-mother" value="mother" disabled />
          Mother (this engine is the mother) </label>
      </div>
    </div>
  </div>

  <div class="form-group">
    <div class="col-sm-offset-2 col-sm-10">
      <a class="btn btn-default" href="settings.html" role="button">&lt; Back</a>
      <button type="button" class="btn btn-primary" data-toggle="modal" data-target=".bs-update-modal-lg"> Update </button>
      <button type="button" class="btn btn-danger" id="searsia-delete-button"> Delete </button>
    </div>
  </div>
</form>


<div class="modal fade bs-update-modal-lg" id="test-results-modal" tabindex="-1" role="dialog" aria-labelledby="Test Results">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title" id="test-results-label">Test Results</h4>
      </div>
      <div class="modal-body">

<ul class="nav nav-tabs" id="test-results-tab">
  <li class="active"><a href="#result">Result</a></li>
  <li><a href="#json">JSON</a></li>
  <li><a href="#xml">XML</a></li>
</ul>
 
<div class="tab-content">
  <div class="tab-pane active" id="result">
    <textarea id="searsia-debug-result" class="form-control" rows="16" style="font-family:monospace;background-color:white;resize:none" readonly />
... loading ... 
    </textarea>
  </div>
  <div class="tab-pane" id="json">
    <textarea id="searsia-debug-json" class="form-control" rows="16" style="font-family:monospace;background-color:white;resize:none" readonly />
    </textarea>
  </div>
  <div class="tab-pane" id="xml">
    <textarea id="searsia-debug-xml" class="form-control" rows="16" style="font-family:monospace;background-color:white;resize:none" readonly />
    </textarea>

  </div>
</div>


      </div>
    </div>
  </div>
</div>


            </div>
          </div>
        </div>
        <div class="col-md-4">
        </div>
      </div>
      <div class="row">
        <div class="col-md-8">
          <div class="searsia-bottom" id="searsia-alert-bottom">
            <noscript>Enable Javascript and use a modern browser to use Search.</noscript>
            <img src="images/progress.gif" alt="retrieving engines..."/>
          </div>
        <div class="col-md-4">
        </div>
      </div>
   
    </div> <!-- /container -->
    <script src="js/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/searsia.js"></script>
    <script> <!--
      $(document).ready(function() {
         placeBanner({ });
         placeIcon({ });
         placeName({ });
         $("#searsia-banner").fadeIn();
         var params = searsiaUrlParameters();
         if (params.r != '') {
            $('head title').append(' ' + params.r);
            var r = localGetResource(params.r); 
            if (r == null) {
                alertMessage('danger', 'Engine "' + params.r + '" does not exist.');
            } else {
                updateForm(r);
            }
         }
         $('#searsia-alert-bottom').html('');

      });
      
      $("#test-results-tab a").click(function(e){
          e.preventDefault();
          $(this).tab('show');
      });

      $('#test-results-modal').on('show.bs.modal', function (e) {
          var timing, engineType,
              resource = { },
              postObject = { },
              startTime = new Date(),
              params = searsiaUrlParameters();
          $('#searsia-debug-result').html('... loading ...');
          $('#searsia-debug-json').html(' ');
          $('#searsia-debug-xml').html(' ');
          resource = form2Resource($('#searsia-engine-form').serializeArray());
          postObject.resource = resource;
          postObject.searsia = 'v0.3.1';
          if (resource.engineType != null) {
              engineType = resource.engineType;
              delete resource.engineType;
          }
          if (resource.id != null) { 
              $('#test-results-label').html('Test results for <em>'+ resource.id + '</em>');
              if (resource.testquery != null) {
                  $('#test-results-label').append(', query: <em>"'+ resource.testquery + '"</em>');
              }
          }
          if (engineType === 'atmother') {
              $.ajax({
                  url: "http://localhost:16842/searsia/update/" + resource.id, 
                  type: 'PUT',
                  contentType: 'application/searsia+json; charset=utf-8',
                  data: JSON.stringify(postObject),
                  timeout: 10000,
                  success: function (data, textStatus, jqXHR) {
                      var count,
                          debug,
                          message,
                          newResource;
                      timing = new Date() - startTime;
                      if (data.hits != null) {
                          count = data.hits.length;
                      } else {
                          count = 0;
                      } 
                      message = 'Update succeeded.\n200 Ok.\n' + count + ' result(s).\n' + timing + ' miliseconds.\n';
                      $('#searsia-debug-result').text(message);
                      debug = data.debug;
                      if (debug != null) { delete data.debug; }
                      $('#searsia-debug-json').html(JSON.stringify(data, null, 2));
                      $('#searsia-debug-xml').text(formatXML(debug)); // https://gist.github.com/sente/1083506
                      $('#searsia-delete-button').attr("disabled", false);
                      alertMessage('success', message);
                      newResource = data.resource;
                      if (newResource != null) {
                          newResource.id = resource.id; // do not change id
                          resource = newResource;
                      } 
                      localSetResource(resource);
                      updateForm(resource);
                  },
                  error: function (jqXHR, textStatus, errorThrown) {
                      var message = 'Update failed.\n' + jqXHR.status + ' ' + jqXHR.statusText + '.\n',
                          data = jqXHR.responseJSON,
                          debug,
                          error;
                      if (data != null) {
                          debug = data.debug;
                          if (debug != null) { delete data.debug; }
                          error = data.error;
                          if (error != null) { error =  message + error; } 
                      } else {
                          data = 'No result';
                      }
                      $('#searsia-debug-result').html(error);
                      $('#searsia-debug-json').html(JSON.stringify(jqXHR.responseJSON, null, 2));
                      $('#searsia-debug-xml').text(formatXML(debug));
                      alertMessage('danger', message);
                      resource['error'] = 'Update failed';
                      localSetResource(resource);
                  }
              });
          } else { 
              $('#searsia-debug-result').html('Update failed.\nLocal engines not implemented.\n');
          }
          
      })

      $("#searsia-delete-button").click(function(e){
          var params;
          e.preventDefault();
          params = searsiaUrlParameters();
          if (params.r != '') {
              $.ajax({
                  url: "http://localhost:16842/searsia/update/" + params.r,
                  type: 'DELETE',
                  success: function (data, textStatus, jqXHR) {
                      localDeleteResource(params.r);
                      $('#searsia-delete-button').attr("disabled", true);
                      alertMessage('info', 'Engine "' + params.r + '" deleted.');
                  },
                  error: function (jqXHR, textStatus, errorThrown) {
                      var resource = localGetResource(params.r);
                      if (resource != null) {
                          resource['error'] = 'Delete failed';
                          localSetResource(resource);
                      }
                      alertMessage('danger', 'Deletion of engine "' + params.r + '" failed:' + jqXHR.status + ' ' + jqXHR.responseText + '.\n');
                  }
              });
          }
      });

      function updateForm(r) {
          if (r != null) {
              if (r.id != null) { $('#engine-id').attr('value', r.id); }
              if (r.name != null) { $('#engine-name').attr('value', r.name); }
              if (r.favicon != null) { $('#engine-favicon').attr('value', r.favicon); }
              if (r.urltemplate != null) { $('#engine-urltemplate').attr('value', r.urltemplate); }
              if (r.apitemplate != null) { $('#engine-apitemplate').attr('value', r.apitemplate); }
              if (r.post != null) { $('#engine-post').attr('value', r.post); }
              if (r.mimetype != null) { $('#engine-mimetype').attr('value', r.mimetype); }
              if (r.testquery != null) { $('#engine-testquery').attr('value', r.testquery); }
              if (r.itempath != null) { $('#engine-itempath').attr('value', r.itempath); }
              if (r.extractors != null) { addAllLines('xpath', r.extractors); }
              if (r.headers != null) { addAllLines('header', r.headers); }
              if (r.params != null) { addAllLines('param', r.params); }
              if (r.error != null) { alertMessage('danger', r.error); }
              else { } // TODO: get params from templates
          } 
      }

      function stringStartsWith (string, prefix) {
          return string.slice(0, prefix.length) == prefix;
      }

      function specialField(formResult, i, type, typeObject) {
          if (stringStartsWith(formResult[i].name, 'engine-' + type + '-key-')) {
              if (i + 1 < formResult.length && stringStartsWith(formResult[i + 1].name, 'engine-' + type + '-value-')) {
                  typeObject[formResult[i].value] = formResult[i + 1].value;
              } else {
                  console.log("Error: missing value for " + formResult[i].name);
              }
              return true;
          }
          return false;
      }
 
      function updateResourceSpecial(resource, type, typeObject) {
          if (Object.keys(typeObject).length !== 0) {
              resource[type] = typeObject;
          }
      }

      function form2Resource(formResult) {
          var resource = { },
              extractors = { },
              headers = { },
              params = { },
              i = 0;
          while (i < formResult.length) {
             if (formResult[i].value != null && formResult[i].value !== "") {
                 if (specialField(formResult, i, 'xpath', extractors) ||
                     specialField(formResult, i, 'header', headers) ||
                     specialField(formResult, i, 'param', params)) {
                     i += 1;
                 } else {
                     resource[formResult[i].name] = formResult[i].value;
                 }
             }
             i += 1;
          }
          updateResourceSpecial(resource, 'extractors', extractors);
          updateResourceSpecial(resource, 'headers', headers);
          updateResourceSpecial(resource, 'parameters', params);
          return resource;
      }

      function addLine(type) {
          var field = '#engine-additional-' + type,
              attr;
          nr = $(field).find('.additional-line').length + 1;
          result  = '<div class="additional-line">';
          result += ' <div class="form-group">';
          result += '  <div class="col-sm-offset-2 col-sm-4">';
          result += '   <input type="text" class="form-control" ';
          attr = 'engine-' + type + '-key-' + nr;
          result += 'id="' + attr + '" name="' + attr + '"> </div>';
          result += '  <div class="col-sm-4">';
          result += '   <input type="text" class="form-control" ';
          attr = 'engine-' + type + '-value-' + nr;
          result += 'id="' + attr + '" name="' + attr + '"> </div>';
          result += '  <div class="col-sm-2">';
          result += '   <button type="button" class="btn btn-default" onclick="addLine(\'' + type + '\');">+</button>';
          result += '   <button type="button" class="btn btn-default" onclick="removeLine($(this));">&#8722;</button> ';
          result += ' </div></div></div>';
          $(field).append(result);
      }
   
      function removeLine(node) {
          node.parent().parent().remove();
      }

      function addAllLines(type, typeObject) {
          var keys = Object.keys(typeObject);
          for(var i=0; i < keys.length; i += 1) {
              if (i > 0) {
                  addLine(type);
              }
              $('#engine-' + type + '-key-' + i).attr('value', keys[i]);
              $('#engine-' + type + '-value-' + i).attr('value', typeObject[keys[i]]);
          }
      }

      function alertMessage(type, message) {
          var alertHTML = '',
              header;
          if (type === 'danger') {
              header = 'Error';
          } else if (type === 'success') {
              header = 'Succes';
          } else {
              header = 'Info';
              type = 'info';
          }
          alertHTML += '<div class="alert alert-' + type + '" role="alert">';
          alertHTML += '<strong>' + header + ': </strong>';
          alertHTML += message + '</div>';
          $('#searsia-alert-top').html(alertHTML);
      }

      function formatXML(xml) {
          if (xml != null) {
              xml = xml.replace(/\s+/g, ' ');
              xml = xml.replace(/>\s*</g, '>\n<');
          }
          return xml;
      }

      -->
    </script>

  </body>
</html>

